{% extends "base.html" %}

{% block title %}Заказ №{{ order.id }}{% endblock %}

{% block content %}
<main class="container my-5">
    <div class="card shadow-lg border-indigo">
        <div class="card-header bg-saffron text-white">
            <h4 class="mb-0">Заказ №{{ order.id }}</h4>
        </div>
        <div class="card-body">
            <p><strong>Дата создания:</strong> {{ order.created_at.strftime('%d.%m.%Y %H:%M') }}</p>
            <p><strong>Статус:</strong>
                <span class="text-{{ order.status.value|lower }}">{{ order.status.value }}</span>  <!-- Используем значение из Enum -->
            </p>

            <hr>
            <h5 class="mt-3">Товары:</h5>
            <ul class="list-group list-group-flush mb-3">
                {% for item in order.order_items %}
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>{{ item.product_name_snapshot }}</strong><br>
                        Кол-во: {{ item.quantity }}
                    </div>
                    <span>{{ "%.2f"|format(item.price_at_time|float) }} ₽</span> <!-- Форматирование цены -->
                </li>
                {% endfor %}
            </ul>

            <div class="text-end">
                <h5>Итого: {{ "%.2f"|format(order.total_price|float) }} ₽</h5>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between">
            {% if order.status.value == 'оформлен' %}  <!-- Статус теперь сравниваем с его строковым значением -->
            <button class="btn btn-danger" onclick="cancelOrder({{ order.id }})">Отменить заказ</button>
            {% endif %}
            <a href="/pages/orders" class="btn btn-outline-secondary">Назад к списку заказов</a>
        </div>
    </div>
</main>

<script>
    async function cancelOrder(orderId) {
        try {
            const response = await fetch(`/orders/${orderId}/cancel`, {
                method: 'POST',
            });
            if (!response.ok) {
                throw new Error('Не удалось отменить заказ');
            }
            alert('Заказ отменён');
            window.location.reload();  // Перезагружаем страницу для обновления состояния
        } catch (error) {
            console.error(error);
            alert('Ошибка при отмене заказа');
        }
    }
</script>
{% endblock %}
